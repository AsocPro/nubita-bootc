# Authentik Blueprint: Grafana OAuth Provider
# Automatically creates OAuth provider and application for Grafana SSO
# See: https://goauthentik.io/docs/flow/blueprints/

version: 1
metadata:
  name: Grafana OAuth Provider
  labels:
    blueprints.goauthentik.io/instantiate: "true"

entries:
  # OAuth2 Provider for Grafana
  - model: authentik_providers_oauth2.oauth2provider
    id: grafana-provider
    identifiers:
      name: Grafana
    attrs:
      name: Grafana
      client_type: confidential
      client_id: grafana
      # This will be auto-generated if not specified
      # In production, you should set a specific client_secret
      # client_secret: "your-secure-secret-here"
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      redirect_uris: |
        https://grafana.local/login/generic_oauth
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, "authentik Self-signed Certificate"]]
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]

  # Application for Grafana
  - model: authentik_core.application
    id: grafana-app
    identifiers:
      slug: grafana
    attrs:
      name: Grafana
      slug: grafana
      provider: !KeyOf grafana-provider
      meta_icon: https://grafana.com/static/assets/img/fav32.png
      meta_description: "Monitoring and observability platform"
      meta_launch_url: https://grafana.local
      policy_engine_mode: any
      open_in_new_tab: true
