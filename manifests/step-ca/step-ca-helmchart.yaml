# step-certificates HelmChart for k3s Helm Controller
# Internal Certificate Authority for automatic TLS
# See: https://smallstep.com/docs/step-ca

apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: step-certificates
  namespace: kube-system
spec:
  repo: https://smallstep.github.io/helm-charts
  chart: step-certificates
  targetNamespace: step-ca
  createNamespace: true

  # step-ca configuration
  valuesContent: |-
    # Bootstrap configuration
    # This will auto-generate CA certificates and configuration on first run
    bootstrap:
      enabled: true
      configmaps: true
      secrets: true

    # Inject configuration - minimal, let bootstrap handle the rest
    inject:
      enabled: false

    # Service configuration
    service:
      type: ClusterIP
      port: 443
      targetPort: 9000

    # Resources for home server
    resources:
      requests:
        cpu: 10m
        memory: 32Mi
      limits:
        cpu: 100m
        memory: 128Mi

    # Persistence for CA database
    persistence:
      enabled: true
      storageClass: longhorn
      size: 1Gi
      accessMode: ReadWriteOnce

    # CA certificate validity periods
    ca:
      # Root CA valid for 10 years
      root:
        validity: 87600h
      # Intermediate CA valid for 5 years
      intermediate:
        validity: 43800h
      # Issued certificates valid for 24 hours (auto-renewed)
      defaultCertValidity: 24h
